<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.erp.mapper.Sdept_approvedMapper">

    <resultMap type="Sdept_approved" id="Sdept_approvedResult">
        <result property="id"    column="id"    />
        <result property="year"    column="year"    />
        <result property="category"    column="category"    />
        <result property="workName"    column="work_name"    />
        <result property="levelType"    column="level_type"    />
        <result property="awardLevel"    column="award_level"    />
        <result property="track"    column="track"    />
        <result property="certNo"    column="cert_no"    />
        <result property="groupType"    column="group_type"    />
        <result property="contestId"    column="contest_id"    />
        <result property="deptId"    column="dept_id"    />
        <result property="awardTime"    column="award_time"    />
        <result property="submitTime"    column="submit_time"    />
        <result property="entryFee"    column="entry_fee"    />
        <result property="auditStatus"    column="audit_status"    />
        <result property="deptAuditUser"    column="dept_audit_user"    />
        <result property="deptAuditTime"    column="dept_audit_time"    />
        <result property="deptAuditReason"    column="dept_audit_reason"    />
        <result property="schoolAuditUser"    column="school_audit_user"    />
        <result property="schoolAuditTime"    column="school_audit_time"    />
        <result property="schoolAuditReason"    column="school_audit_reason"    />
        <result property="isReimburse"    column="is_reimburse"    />
        <result property="reimburseFee"    column="reimburse_fee"    />
        <result property="reimburseRatio"    column="reimburse_ratio"    />
        <result property="reimburseProjectId"    column="reimburse_project_id"    />
        <result property="reimbursePayTime"    column="reimburse_pay_time"    />
        <result property="reimburseAuditStatus"    column="reimburse_audit_status"    />
        <result property="reimburseAuditTime"    column="reimburse_audit_time"    />
        <result property="reimburseAuditUserId"    column="reimburse_audit_user_id"    />
        <result property="reimburseAuditReason"    column="reimburse_audit_reason"    />
        <result property="delFlag"    column="del_flag"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
        <result property="remark"    column="remark"    />
    </resultMap>

    <resultMap id="Sdept_approvedErpContestantResult" type="Sdept_approved" extends="Sdept_approvedResult">
        <collection property="erpContestantList" ofType="ErpContestant" column="id" select="selectErpContestantList" />
    </resultMap>

    <resultMap type="ErpContestant" id="ErpContestantResult">
        <result property="id"    column="id"    />
        <result property="outcomeId"    column="outcome_id"    />
        <result property="studentCode"    column="student_code"    />
        <result property="sortOrder"    column="sort_order"    />
        <result property="isLeader"    column="is_leader"    />
        <result property="createBy"    column="create_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateBy"    column="update_by"    />
        <result property="updateTime"    column="update_time"    />
    </resultMap>

    <sql id="selectSdept_approvedVo">
        select id, year, category, work_name, level_type, award_level, track, cert_no, group_type, contest_id, dept_id, award_time, submit_time, entry_fee, audit_status, dept_audit_user, dept_audit_time, dept_audit_reason, school_audit_user, school_audit_time, school_audit_reason, is_reimburse, reimburse_fee, reimburse_ratio, reimburse_project_id, reimburse_pay_time, reimburse_audit_status, reimburse_audit_time, reimburse_audit_user_id, reimburse_audit_reason, del_flag, create_by, create_time, update_by, update_time, remark
        from erp_outcome
    </sql>

    <select id="selectSdept_approvedList" parameterType="Sdept_approved" resultMap="Sdept_approvedResult">
        <include refid="selectSdept_approvedVo"/>
        <where>
            <if test="id != null "> and id = #{id}</if>
            <if test="year != null "> and year = #{year}</if>
            <if test="category != null  and category != ''"> and category = #{category}</if>
            <if test="levelType != null  and levelType != ''"> and level_type = #{levelType}</if>
            <if test="awardLevel != null  and awardLevel != ''"> and award_level = #{awardLevel}</if>
            <if test="track != null  and track != ''"> and track like concat('%', #{track}, '%')</if>
            <if test="certNo != null  and certNo != ''"> and cert_no = #{certNo}</if>
            <if test="groupType != null  and groupType != ''"> and group_type = #{groupType}</if>
            <if test="deptId != null "> and dept_id like concat('%', #{deptId}, '%')</if>
            <if test="auditStatus != null  and auditStatus != ''"> and audit_status = #{auditStatus}</if>

            <!-- 只查询校级审核通过/校级驳回（按你之前 dept_approved 的思路：限制状态范围） -->
            <if test="auditStatus != null">
                and audit_status in (6, 5)
            </if>
        </where>
    </select>

    <select id="selectByAuditStatuses" resultMap="Sdept_approvedResult">
        <include refid="selectSdept_approvedVo"/>
        <where>
            audit_status in
            <foreach item="status" collection="auditStatus" open="(" separator="," close=")">
                #{status}
            </foreach>
        </where>
    </select>

    <select id="selectSdept_approvedById" parameterType="Long" resultMap="Sdept_approvedErpContestantResult">
        select id, year, category, work_name, level_type, award_level, track, cert_no, group_type, contest_id, dept_id, award_time, submit_time, entry_fee, audit_status, dept_audit_user, dept_audit_time, dept_audit_reason, school_audit_user, school_audit_time, school_audit_reason, is_reimburse, reimburse_fee, reimburse_ratio, reimburse_project_id, reimburse_pay_time, reimburse_audit_status, reimburse_audit_time, reimburse_audit_user_id, reimburse_audit_reason, del_flag, create_by, create_time, update_by, update_time, remark
        from erp_outcome
        where id = #{id}
    </select>

    <select id="selectErpContestantList" resultMap="ErpContestantResult">
        select id, outcome_id, student_code, sort_order, is_leader, create_by, create_time, update_by, update_time
        from erp_contestant
        where outcome_id = #{outcome_id}
    </select>

    <!-- ======================= INSERT ======================= -->
    <!-- 要求与前文一致：
         1) submit_time 永远 NOW()
         2) year 默认当前年份（IFNULL）
         3) 除 work_name 可选，其余（category/level_type/award_level/track/cert_no/group_type/dept_id/award_time/entry_fee/audit_status/is_reimburse）按“必填”固定写入
         4) contest_id 可选
    -->
    <insert id="insertSdept_approved" parameterType="Sdept_approved" useGeneratedKeys="true" keyProperty="id">
        insert into erp_outcome
        <trim prefix="(" suffix=")" suffixOverrides=",">
            year,
            category,
            <if test="workName != null and workName != ''">work_name,</if>

            level_type,
            award_level,
            track,
            cert_no,
            group_type,
            dept_id,
            award_time,

            submit_time,

            entry_fee,
            audit_status,
            is_reimburse,

            <if test="contestId != null">contest_id,</if>

            <if test="deptAuditUser != null">dept_audit_user,</if>
            <if test="deptAuditTime != null">dept_audit_time,</if>
            <if test="deptAuditReason != null">dept_audit_reason,</if>
            <if test="schoolAuditUser != null">school_audit_user,</if>
            <if test="schoolAuditTime != null">school_audit_time,</if>
            <if test="schoolAuditReason != null">school_audit_reason,</if>

            <if test="reimburseFee != null">reimburse_fee,</if>
            <if test="reimburseRatio != null">reimburse_ratio,</if>
            <if test="reimburseProjectId != null">reimburse_project_id,</if>
            <if test="reimbursePayTime != null">reimburse_pay_time,</if>
            <if test="reimburseAuditStatus != null">reimburse_audit_status,</if>
            <if test="reimburseAuditTime != null">reimburse_audit_time,</if>
            <if test="reimburseAuditUserId != null">reimburse_audit_user_id,</if>
            <if test="reimburseAuditReason != null">reimburse_audit_reason,</if>

            <if test="delFlag != null">del_flag,</if>
            <if test="createBy != null">create_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="remark != null">remark,</if>
        </trim>

        <trim prefix="values (" suffix=")" suffixOverrides=",">
            IFNULL(#{year}, DATE_FORMAT(NOW(), '%Y')),
            #{category},
            <if test="workName != null and workName != ''">#{workName},</if>

            #{levelType},
            #{awardLevel},
            #{track},
            #{certNo},
            #{groupType},
            #{deptId},
            #{awardTime},

            NOW(),

            #{entryFee},
            #{auditStatus},
            #{isReimburse},

            <if test="contestId != null">#{contestId},</if>

            <if test="deptAuditUser != null">#{deptAuditUser},</if>
            <if test="deptAuditTime != null">#{deptAuditTime},</if>
            <if test="deptAuditReason != null">#{deptAuditReason},</if>
            <if test="schoolAuditUser != null">#{schoolAuditUser},</if>
            <if test="schoolAuditTime != null">#{schoolAuditTime},</if>
            <if test="schoolAuditReason != null">#{schoolAuditReason},</if>

            <if test="reimburseFee != null">#{reimburseFee},</if>
            <if test="reimburseRatio != null">#{reimburseRatio},</if>
            <if test="reimburseProjectId != null">#{reimburseProjectId},</if>
            <if test="reimbursePayTime != null">#{reimbursePayTime},</if>
            <if test="reimburseAuditStatus != null">#{reimburseAuditStatus},</if>
            <if test="reimburseAuditTime != null">#{reimburseAuditTime},</if>
            <if test="reimburseAuditUserId != null">#{reimburseAuditUserId},</if>
            <if test="reimburseAuditReason != null">#{reimburseAuditReason},</if>

            <if test="delFlag != null">#{delFlag},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="remark != null">#{remark},</if>
        </trim>
    </insert>

    <!-- ======================= UPDATE ======================= -->
    <!-- 要求与前文一致：submit_time 永远 NOW(); work_name 可选更新 -->
    <update id="updateSdept_approved" parameterType="Sdept_approved">
        update erp_outcome
        <trim prefix="SET" suffixOverrides=",">
            <if test="year != null">year = #{year},</if>
            <if test="category != null and category != ''">category = #{category},</if>

            <if test="workName != null and workName != ''">work_name = #{workName},</if>

            <if test="levelType != null and levelType != ''">level_type = #{levelType},</if>
            <if test="awardLevel != null and awardLevel != ''">award_level = #{awardLevel},</if>
            <if test="track != null and track != ''">track = #{track},</if>
            <if test="certNo != null and certNo != ''">cert_no = #{certNo},</if>
            <if test="groupType != null and groupType != ''">group_type = #{groupType},</if>
            <if test="contestId != null">contest_id = #{contestId},</if>
            <if test="deptId != null">dept_id = #{deptId},</if>
            <if test="awardTime != null">award_time = #{awardTime},</if>

            submit_time = NOW(),

            <if test="entryFee != null">entry_fee = #{entryFee},</if>
            <if test="auditStatus != null">audit_status = #{auditStatus},</if>
            <if test="deptAuditUser != null">dept_audit_user = #{deptAuditUser},</if>
            <if test="deptAuditTime != null">dept_audit_time = #{deptAuditTime},</if>
            <if test="deptAuditReason != null">dept_audit_reason = #{deptAuditReason},</if>
            <if test="schoolAuditUser != null">school_audit_user = #{schoolAuditUser},</if>
            <if test="schoolAuditTime != null">school_audit_time = #{schoolAuditTime},</if>
            <if test="schoolAuditReason != null">school_audit_reason = #{schoolAuditReason},</if>
            <if test="isReimburse != null">is_reimburse = #{isReimburse},</if>

            <if test="reimburseFee != null">reimburse_fee = #{reimburseFee},</if>
            <if test="reimburseRatio != null">reimburse_ratio = #{reimburseRatio},</if>
            <if test="reimburseProjectId != null">reimburse_project_id = #{reimburseProjectId},</if>
            <if test="reimbursePayTime != null">reimburse_pay_time = #{reimbursePayTime},</if>
            <if test="reimburseAuditStatus != null">reimburse_audit_status = #{reimburseAuditStatus},</if>
            <if test="reimburseAuditTime != null">reimburse_audit_time = #{reimburseAuditTime},</if>
            <if test="reimburseAuditUserId != null">reimburse_audit_user_id = #{reimburseAuditUserId},</if>
            <if test="reimburseAuditReason != null">reimburse_audit_reason = #{reimburseAuditReason},</if>

            <if test="delFlag != null">del_flag = #{delFlag},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="remark != null">remark = #{remark},</if>
        </trim>
        where id = #{id}
    </update>

    <!-- ======================= WAIT（修复版） ======================= -->
    <!-- 说明：
         1) 你之前的 wait 是错误写法：set auditStatus, deptAuditReason 这种 MySQL 不认识
         2) 这里按“学校审核”字段更新：audit_status / school_audit_reason / school_audit_time / school_audit_user
         3) 如果你业务里 Sdept_approved 是“学校已审核/驳回”，这样最符合
    -->
    <update id="wait" parameterType="Sdept_approved">
        update erp_outcome
        set audit_status = #{auditStatus},
            school_audit_reason = #{schoolAuditReason},
            school_audit_time = NOW(),
            school_audit_user = #{schoolAuditUser}
        where id = #{id}
    </update>

    <delete id="deleteSdept_approvedById" parameterType="Long">
        delete from erp_outcome where id = #{id}
    </delete>

    <delete id="deleteSdept_approvedByIds" parameterType="String">
        delete from erp_outcome where id in
        <foreach item="id" collection="array" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <delete id="deleteErpContestantByOutcomeIds" parameterType="String">
        delete from erp_contestant where outcome_id in
        <foreach item="outcomeId" collection="array" open="(" separator="," close=")">
            #{outcomeId}
        </foreach>
    </delete>

    <delete id="deleteErpContestantByOutcomeId" parameterType="Long">
        delete from erp_contestant where outcome_id = #{outcomeId}
    </delete>

    <insert id="batchErpContestant">
        insert into erp_contestant( id, outcome_id, student_code, sort_order, is_leader, create_by, create_time, update_by, update_time) values
        <foreach item="item" index="index" collection="list" separator=",">
            ( #{item.id}, #{item.outcomeId}, #{item.studentCode}, #{item.sortOrder}, #{item.isLeader}, #{item.createBy}, #{item.createTime}, #{item.updateBy}, #{item.updateTime})
        </foreach>
    </insert>

</mapper>
